# دليل إدارة المستخدمين والأمان - ورشة العمل الشاملة

## نظرة عامة

يوفر نظام إدارة المستخدمين والأمان في ورشة العمل الشاملة إطار عمل متقدم للحماية والتحكم في الوصول، مصمم خصيصاً لبيئة ورش صيانة السيارات في عُمان.

## المكونات الأساسية

### 1. نموذج الأدوار والصلاحيات

#### الأدوار المتاحة:
- **مدير الورشة**: الوصول الكامل لجميع العمليات
- **مشرف الورشة**: إدارة العمليات اليومية والفنيين
- **مستشار الخدمة**: التعامل مع العملاء وطلبات الخدمة
- **مدير قطع الغيار**: إدارة المخزون وطلبات القطع
- **فني**: تنفيذ أعمال الصيانة والإصلاح
- **موظف مالي**: إدارة الفواتير والمدفوعات

#### مستويات الصلاحيات:
- **قراءة**: عرض البيانات فقط
- **كتابة**: تعديل البيانات الموجودة
- **إنشاء**: إنشاء سجلات جديدة
- **حذف**: حذف السجلات
- **إرسال**: تأكيد المعاملات
- **إلغاء**: إلغاء المعاملات المؤكدة

### 2. محرك الصلاحيات المخصص

#### الميزات المتقدمة:
- **صلاحيات ديناميكية**: تعتمد على السياق والحالة
- **صلاحيات على مستوى الصف**: تحكم دقيق في البيانات
- **صلاحيات على مستوى الحقل**: إخفاء أو حماية حقول محددة
- **شروط مخصصة**: قواعد معقدة للوصول

#### أمثلة الاستخدام:
```python
# مثال: فني يمكنه رؤية أوامر العمل المخصصة له فقط
if user_role == "Technician":
    filters.update({"assigned_technician": user.email})

# مثال: إخفاء معلومات التكلفة عن الفنيين
if user_role == "Technician":
    hide_fields = ["cost_price", "profit_margin"]
```

### 3. لوحة معلومات الأمان

#### المؤشرات الرئيسية:
- **المستخدمون النشطون**: عدد المستخدمين المتصلين حالياً
- **محاولات تسجيل الدخول الفاشلة**: آخر 24 ساعة
- **تغييرات الصلاحيات**: التعديلات الأخيرة
- **التنبيهات الأمنية**: الأحداث المشبوهة
- **جلسات المستخدمين**: مراقبة النشاط

#### التقارير المتاحة:
- تقرير نشاط المستخدمين اليومي
- تقرير تغييرات الصلاحيات الشهري
- تقرير الأحداث الأمنية
- تقرير استخدام النظام

### 4. المصادقة متعددة العوامل (MFA)

#### طرق المصادقة المدعومة:
- **تطبيقات المصادقة**: Google Authenticator، Microsoft Authenticator
- **رسائل SMS**: إرسال رمز التحقق عبر الهاتف
- **WhatsApp**: إرسال رمز التحقق عبر واتساب
- **البريد الإلكتروني**: إرسال رمز التحقق عبر الإيميل

#### إعداد MFA للمستخدمين:
1. انتقل إلى صفحة إعدادات المستخدم
2. انقر على "تفعيل المصادقة متعددة العوامل"
3. اختر طريقة المصادقة المفضلة
4. امسح رمز QR بتطبيق المصادقة
5. أدخل رمز التحقق للتأكيد
6. احفظ رموز النسخ الاحتياطية

#### رموز النسخ الاحتياطية:
- يتم إنشاء 10 رموز احتياطية
- كل رمز يُستخدم مرة واحدة فقط
- احفظها في مكان آمن
- يمكن إنشاء رموز جديدة عند الحاجة

### 5. إدارة الجلسات المتقدمة

#### سياسات الجلسات:
- **انتهاء الوقت المحدد**: 15-30 دقيقة خمول
- **الحد الأقصى للجلسات**: 1-5 جلسات متزامنة
- **جلسة واحدة فقط**: للأدوار الحساسة
- **مراقبة الأجهزة**: تتبع المتصفح ونظام التشغيل

#### مراقبة الجلسات:
```javascript
// عرض جلسات المستخدم النشطة
frappe.call({
    method: 'universal_workshop.user_management.session_manager.get_session_status',
    args: { user_email: 'user@workshop.com' },
    callback: function(r) {
        console.log('Active Sessions:', r.message);
    }
});
```

#### إلغاء الجلسات:
- إلغاء جلسة محددة
- إلغاء جميع جلسات المستخدم
- إلغاء الجلسات منتهية الصلاحية تلقائياً

### 6. مسار التدقيق الموسع

#### الأحداث المسجلة:
- **أحداث تسجيل الدخول**: نجح، فشل، خروج
- **أحداث MFA**: تفعيل، إلغاء تفعيل، فشل التحقق
- **أحداث الجلسات**: إنشاء، انتهاء، إلغاء
- **تغييرات الأدوار**: تعيين، إلغاء تعيين
- **منح الصلاحيات**: إضافة، حذف، تعديل
- **الأنشطة المشبوهة**: محاولات غير مصرح بها

#### بنية سجل التدقيق:
```json
{
    "event_id": "SEC-2024-001234",
    "event_type": "login_failed",
    "severity": "medium",
    "timestamp": "2024-06-23T10:30:00Z",
    "user_email": "user@workshop.com",
    "description": "محاولة تسجيل دخول فاشلة",
    "details": {
        "ip_address": "192.168.1.100",
        "user_agent": "Chrome/91.0",
        "failure_reason": "كلمة مرور خاطئة"
    }
}
```

### 7. التنبيهات والإشعارات الأمنية

#### أنواع التنبيهات:
- **فشل تسجيل الدخول**: 3 محاولات في 10 دقائق
- **محاولات متعددة فاشلة**: 5 محاولات في 15 دقيقة
- **تغيير الصلاحيات**: أي تعديل على الأدوار
- **إلغاء تفعيل MFA**: فوري
- **نشاط مشبوه**: 3 أحداث في 60 دقيقة

#### قنوات الإشعار:
- **البريد الإلكتروني**: للتنبيهات العادية
- **رسائل SMS**: للتنبيهات العاجلة
- **WhatsApp**: للتنبيهات الحرجة
- **داخل التطبيق**: للمعلومات الفورية

#### سياسات التصعيد:
1. **مشرف الورشة**: التنبيهات العادية
2. **مدير الورشة**: التنبيهات المتوسطة
3. **مدير النظام**: التنبيهات الحرجة
4. **الطوارئ**: جميع القنوات

## دليل الاستخدام للمديرين

### إعداد النظام الأولي

#### 1. إنشاء الأدوار:
```bash
# تشغيل سكريبت إعداد الأدوار
bench --site universal.local execute universal_workshop.user_management.setup_roles
```

#### 2. تكوين سياسات الأمان:
1. انتقل إلى "إعدادات التنبيهات الأمنية"
2. فعّل قنوات الإشعار المطلوبة
3. اضبط عتبات التنبيهات حسب الحاجة
4. احفظ الإعدادات

#### 3. إعداد المستخدمين:
1. أنشئ حسابات المستخدمين
2. اعيّن الأدوار المناسبة
3. فعّل MFA للأدوار الحساسة
4. اضبط سياسات الجلسات

### إدارة المستخدمين اليومية

#### إضافة مستخدم جديد:
1. انتقل إلى "قائمة المستخدمين"
2. انقر "جديد"
3. املأ البيانات الأساسية
4. اختر الأدوار المناسبة
5. فعّل MFA إذا لزم الأمر
6. احفظ المستخدم

#### تعديل صلاحيات مستخدم:
1. افتح صفحة المستخدم
2. انتقل إلى قسم "الأدوار"
3. أضف أو احذف الأدوار
4. احفظ التغييرات
5. تحقق من سجل التدقيق

#### مراقبة النشاط:
1. افتح لوحة معلومات الأمان
2. راجع التنبيهات الحديثة
3. تحقق من الجلسات النشطة
4. راجع سجل التدقيق

## دليل المطورين

### إضافة صلاحيات مخصصة

#### مثال: صلاحية مشروطة
```python
# في ملف permission_hooks.py
def custom_permission_check(doc, user, permission_type):
    """فحص صلاحية مخصص"""
    if doc.doctype == "Work Order":
        # الفني يمكنه رؤية أوامر العمل المخصصة له فقط
        if frappe.get_roles(user) == ["Technician"]:
            return doc.assigned_technician == user
    return True
```

#### تسجيل حدث في سجل التدقيق:
```python
from universal_workshop.user_management.audit_trail_extension import log_audit_event

# تسجيل حدث أمني
log_audit_event(
    event_type="role_assigned",
    severity="medium",
    user_email=user.email,
    description=f"تم تعيين دور {role_name} للمستخدم",
    details={
        "role_name": role_name,
        "assigned_by": frappe.session.user,
        "timestamp": frappe.utils.now()
    }
)
```

### إضافة تنبيه أمني جديد:
```python
from universal_workshop.user_management.security_alerts import get_security_alerts_manager

# إرسال تنبيه أمني
manager = get_security_alerts_manager()
manager.check_and_trigger_alerts(
    event_type="suspicious_activity",
    user_email=user.email,
    source_ip=frappe.local.request_ip,
    details={
        "activity_type": "unusual_access_pattern",
        "description": "وصول غير عادي من موقع جديد"
    }
)
```

## الامتثال والمراجعة

### متطلبات الامتثال:
- **قانون حماية البيانات العُماني**: تشفير البيانات الحساسة
- **معايير الأمان الدولية**: ISO 27001
- **متطلبات التدقيق**: سجلات تدقيق شاملة
- **الاحتفاظ بالبيانات**: 7 سنوات للسجلات المالية

### قائمة مراجعة الأمان الشهرية:
- [ ] مراجعة سجلات التدقيق
- [ ] فحص التنبيهات الأمنية
- [ ] تحديث كلمات المرور
- [ ] مراجعة صلاحيات المستخدمين
- [ ] فحص الجلسات النشطة
- [ ] تحديث سياسات الأمان
- [ ] اختبار نظام النسخ الاحتياطي
- [ ] مراجعة إعدادات MFA

### تقارير الامتثال:
- تقرير نشاط المستخدمين الشهري
- تقرير الأحداث الأمنية الربع سنوي
- تقرير مراجعة الصلاحيات السنوي
- تقرير اختبار الأمان السنوي

## الدعم الفني

### الأخطاء الشائعة وحلولها:

#### خطأ: "فشل في تسجيل الدخول"
**الحل:**
1. تحقق من كلمة المرور
2. تأكد من تفعيل الحساب
3. فحص إعدادات MFA
4. مراجعة سجل التدقيق

#### خطأ: "انتهت صلاحية الجلسة"
**الحل:**
1. سجل دخول مرة أخرى
2. تحقق من إعدادات انتهاء الجلسة
3. فحص الاتصال بالإنترنت
4. مسح ذاكرة التخزين المؤقت

#### خطأ: "صلاحية غير كافية"
**الحل:**
1. تحقق من الأدوار المعينة
2. راجع صلاحيات الدور
3. تواصل مع مدير النظام
4. فحص الصلاحيات المخصصة

### معلومات الاتصال:
- **الدعم الفني**: support@universal-workshop.om
- **الطوارئ**: +968 24 123456
- **الوثائق**: docs.universal-workshop.om
- **التدريب**: training@universal-workshop.om

---

*آخر تحديث: يونيو 2024*
*الإصدار: 2.0*
*اللغة: العربية* 